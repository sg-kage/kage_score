<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel計算機アプリ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: Noto Sans JP と Fira Code の読み込み -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <!-- Lucide Iconsの読み込み -->
  <script src="https://unpkg.com/lucide@latest/dist/lucide.js"></script>
  <style>
    body {
      font-family: 'Noto Sans JP', sans-serif;
    }
    .font-mono {
      font-family: 'Fira Code', monospace;
    }
    /* スクロール時のモバイルグリッド横スクロール */
    #resultsGrid {
      overflow-x: auto;
    }
    /* モバイルでグリッドが見やすいように */
    @media (max-width: 640px) {
      #resultsGrid > div {
        min-width: 550px;
      }
    }
  </style>
</head>
<body class="bg-[#242424] text-slate-100 p-2 antialiased flex flex-col items-center min-h-screen">

  <div class="w-full max-w-2xl sm:max-w-3xl md:max-w-6xl bg-[#3D3D3D] rounded-xl shadow-2xl p-2 sm:p-4 md:p-8">
    <!-- タイトル -->
    <div class="flex items-center mb-4 sm:mb-6">
      <i data-lucide="edit" class="w-6 h-6 text-slate-400 mr-2 sm:mr-3"></i>
      <input
        type="text"
        id="titleInput"
        value="タイトル"
        class="w-full bg-[#242424] text-base sm:text-lg md:text-xl font-bold border-none rounded-lg py-1 px-2 sm:py-2 sm:px-4 focus:ring-2 focus:ring-green-500 focus:outline-none"
      />
    </div>

    <!-- 入力セクション -->
    <div class="flex flex-col sm:flex-row gap-2 sm:gap-4 mb-2 sm:mb-4">
      <!-- 相手HP -->
      <div class="flex-1 bg-[#242424] p-2 rounded-lg shadow-inner">
        <label class="block text-slate-300 text-xs mb-1">相手HP</label>
        <div class="flex items-center">
          <button id="decrementBaseValue" class="p-0.5 bg-slate-600 rounded-l-lg hover:bg-slate-500 transition-colors">
            <i data-lucide="minus" class="w-4 h-4 text-slate-300"></i>
          </button>
          <input
            type="number"
            id="baseValueInput"
            value="1000000"
            class="flex-1 text-center bg-[#242424] text-white font-mono text-base sm:text-lg py-0.5 focus:ring-2 focus:ring-green-500 focus:outline-none"
          />
          <button id="incrementBaseValue" class="p-0.5 bg-slate-600 rounded-r-lg hover:bg-slate-500 transition-colors">
            <i data-lucide="plus" class="w-4 h-4 text-slate-300"></i>
          </button>
        </div>
      </div>
      <!-- スコアPt -->
      <div class="flex-1 bg-[#242424] p-2 rounded-lg shadow-inner">
        <label class="block text-slate-300 text-xs mb-1">スコアPt</label>
        <div class="flex items-center">
          <button id="decrementAdjustedValue" class="p-0.5 bg-slate-600 rounded-l-lg hover:bg-slate-500 transition-colors">
            <i data-lucide="minus" class="w-4 h-4 text-slate-300"></i>
          </button>
          <input
            type="number"
            id="adjustedValueInput"
            value="600000"
            class="flex-1 text-center bg-[#242424] text-white font-mono text-base sm:text-lg py-0.5 focus:ring-2 focus:ring-green-500 focus:outline-none"
          />
          <button id="incrementAdjustedValue" class="p-0.5 bg-slate-600 rounded-r-lg hover:bg-slate-500 transition-colors">
            <i data-lucide="plus" class="w-4 h-4 text-slate-300"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- 計算結果グリッド -->
    <div class="bg-[#3D3D3D] rounded-lg shadow-lg overflow-x-auto border border-slate-700">
      <div id="resultsGrid">
        <!-- 計算結果はJavaScriptでここに挿入されます -->
      </div>
    </div>
  </div>

  <script>
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
    const titleInput = document.getElementById('titleInput');
    const baseValueInput = document.getElementById('baseValueInput');
    const adjustedValueInput = document.getElementById('adjustedValueInput');
    const resultsGrid = document.getElementById('resultsGrid');
    const incrementBaseValueBtn = document.getElementById('incrementBaseValue');
    const decrementBaseValueBtn = document.getElementById('decrementBaseValue');
    const incrementAdjustedValueBtn = document.getElementById('incrementAdjustedValue');
    const decrementAdjustedValueBtn = document.getElementById('decrementAdjustedValue');

    // 新しい数式に基づく計算ロジック
    const calculateResult = (baseValue, adjustedValue, percentage) => {
      // percentage: 0 ～ 100, ExcelのH6相当
      // adjusted: ($D$8 / (1 + H6) - 20000) / 280000
      // result: ROUNDUP(base * adjusted, 0)
      // percent: result / base
      const h6 = percentage / 100;
      const adjusted = (adjustedValue / (1 + h6) - 20000) / 280000;
      const result = Math.ceil(baseValue * adjusted);
      const percent = result / baseValue;
      const formattedPercent = (percent * 100).toFixed(2) + '%';
      const formattedResult = new Intl.NumberFormat('ja-JP').format(result);

      return `${formattedPercent} [${formattedResult}]`;
    };

    // グリッド表示
    const renderGrid = () => {
      resultsGrid.innerHTML = '';
      const baseValue = Number(baseValueInput.value);
      const adjustedValue = Number(adjustedValueInput.value);

      // ヘッダー
      const headerRow = document.createElement('div');
      headerRow.className = 'grid grid-cols-5 border-b border-slate-700';
      const percentages = ['0%', '20%', '40%', '60%', '80%'];
      percentages.forEach((p, index) => {
        const headerDiv = document.createElement('div');
        headerDiv.className = `text-center font-bold text-base py-1 bg-[#242424] border-r border-slate-700 ${index === 4 ? 'border-r-0' : ''}`;
        headerDiv.textContent = p;
        headerRow.appendChild(headerDiv);
      });
      resultsGrid.appendChild(headerRow);

      // データ分割
      const columnsData = [[], [], [], [], []];
      for (let i = 0; i <= 99; i++) {
        const columnIndex = Math.floor(i / 20);
        if (columnIndex < 5) {
          columnsData[columnIndex].push(i);
        }
      }
      columnsData[4].push(100); // 100%を最後の列に追加

      const maxRows = Math.max(...columnsData.map(col => col.length));
      for (let rowIndex = 0; rowIndex < maxRows; rowIndex++) {
        const rowDiv = document.createElement('div');
        rowDiv.className = 'grid grid-cols-5';
        const isEven = rowIndex % 2 === 0;
        columnsData.forEach((column, colIndex) => {
          const p = column[rowIndex];
          const resultItem = document.createElement('div');
          resultItem.className = `flex items-center text-xs sm:text-sm py-1 px-2 border-b border-slate-700 ${isEven ? 'bg-[#242424]' : 'bg-[#3D3D3D]'} ${colIndex < 4 ? 'border-r' : ''}`;
          if (p !== undefined) {
            const percentageDiv = document.createElement('div');
            percentageDiv.className = "w-1/4 pr-2 font-bold text-white whitespace-nowrap";
            percentageDiv.textContent = `${p}%`;
            const contentDiv = document.createElement('div');
            contentDiv.className = "flex-1 font-mono text-white text-left overflow-hidden overflow-ellipsis";
            contentDiv.textContent = calculateResult(baseValue, adjustedValue, p);
            resultItem.appendChild(percentageDiv);
            resultItem.appendChild(contentDiv);
          }
          rowDiv.appendChild(resultItem);
        });
        resultsGrid.appendChild(rowDiv);
      }
    };

    const handleInput = () => {
      renderGrid();
    };

    baseValueInput.addEventListener('input', handleInput);
    adjustedValueInput.addEventListener('input', handleInput);

    incrementBaseValueBtn.addEventListener('click', () => {
      baseValueInput.value = Number(baseValueInput.value) + 10000;
      handleInput();
    });
    decrementBaseValueBtn.addEventListener('click', () => {
      baseValueInput.value = Math.max(0, Number(baseValueInput.value) - 10000);
      handleInput();
    });
    incrementAdjustedValueBtn.addEventListener('click', () => {
      adjustedValueInput.value = Number(adjustedValueInput.value) + 10000;
      handleInput();
    });
    decrementAdjustedValueBtn.addEventListener('click', () => {
      adjustedValueInput.value = Math.max(0, Number(adjustedValueInput.value) - 10000);
      handleInput();
    });

    // 初期レンダリング
    renderGrid();
  </script>
</body>
</html>
